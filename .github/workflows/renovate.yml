name: Renovate
on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
jobs:
  renovate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Self-hosted Renovate
        uses: renovatebot/github-action@v46.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          RENOVATE_REPOSITORIES: ${{ github.repository }}
      - name: Trigger CI on open Renovate PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr list --author "app/github-actions" --state open --json headRefName \
            --jq '.[].headRefName' | \
          while read branch; do
            echo "Triggering CI for $branch"
            gh workflow run ci.yml --ref main --field ref="$branch"
          done
